#!/bin/sh

# This is the bash script that reproduces the paper results of the MICCAI23 paper #3159 entitled:
# Unsupervised Domain Transfer with Conditional Invertible Neural Networks

# TODO Adjust the following line to the parent folder of where you have stored the folders 'HSI_Data' and 'PAI_Data'!
#export DATA_BASE_PATH="/Path/to/raw/data"
export DATA_BASE_PATH="/home/kris/Work/Data/domain_adaptation_simulations"
export HSI_DATA_PATH="$DATA_BASE_PATH/HSI_Data/organ_data"
export PAT_DATA_PATH="$DATA_BASE_PATH/PAT_Data"

# TODO Adjust the following line depending on where you saved the data generated by the pretrained models!
export SAVE_DATA_PATH="/home/kris/Work/Data/Test/data"

mkdir "$SAVE_DATA_PATH/results"
mkdir "$SAVE_DATA_PATH/results/inn"
mkdir "$SAVE_DATA_PATH/results/unit"
mkdir "$SAVE_DATA_PATH/results/pca"

export PYTHON_PATH="$PWD"

cINN_DY_PATH="$SAVE_DATA_PATH/gan_cinn/cINN_DY"
cINN_D_PATH="$SAVE_DATA_PATH/gan_cinn/cINN_D"
cINN_WG_PATH="$SAVE_DATA_PATH/gan_cinn/cINN_without_GAN"

cINN_DY_PATH_HSI="$SAVE_DATA_PATH/gan_cinn_hsi/cINN_DY/testing/generated_spectra_data"
cINN_D_PATH_HSI="$SAVE_DATA_PATH/gan_cinn_hsi/cINN_D/testing/generated_spectra_data"
cINN_WG_PATH_HSI="$SAVE_DATA_PATH/gan_cinn_hsi/cINN_without_GAN/testing/generated_spectra_data"

UNIT_Y_PATH="$SAVE_DATA_PATH/unit/UNIT_Y"
UNIT_PATH="$SAVE_DATA_PATH/unit/UNIT"

UNIT_Y_PATH_HSI="$SAVE_DATA_PATH/unit_hsi/UNIT_Y/testing/generated_spectra_data"
UNIT_PATH_HSI="$SAVE_DATA_PATH/unit_hsi/UNIT/testing/generated_spectra_data"

CYCLEGAN_PATH="$SAVE_DATA_PATH/cycle_gan/CycleGAN"
CYCLEGAN_PATH_HSI="$SAVE_DATA_PATH/cycle_gan_hsi/CycleGAN/testing/generated_spectra_data"

echo "Train and evaluate Random Forest Classifier on PAT Data generated by cINN_D and UNIT"
python3 evaluation/artery_vein_classifier.py "--target" "test" "--data_base_root" "$PAT_DATA_PATH" "--gan_cinn_root" "$cINN_D_PATH/testing/training" "--unit_root" "$UNIT_PATH/testing/training" > "$SAVE_DATA_PATH/cINN_D_UNIT.txt"
echo "Train and evaluate Random Forest Classifier on PAT Data generated by cINN_without_GAN and CycleGAN"
python3 evaluation/artery_vein_classifier.py "--target" "test" "--data_base_root" "$PAT_DATA_PATH" "--gan_cinn_root" "$cINN_WG_PATH/testing/training" "--unit_root" "$CYCLEGAN_PATH/testing/training" > "$SAVE_DATA_PATH/cINN_WG_CYCLEGAN.txt"

# Please note that cINN_D and UNIT will be the values for 'inn' and 'unit', respectively.
echo "Train and evaluate Random Forest Classifier on HSI Data generated by cINN_D and UNIT"
cp -r "$cINN_D_PATH_HSI" "$SAVE_DATA_PATH/results/inn/generated_spectra_data"
cp -r "$UNIT_PATH_HSI" "$SAVE_DATA_PATH/results/unit/generated_spectra_data"
python3 evaluation/si_classifier.py "--rf" "--target" "test" > "$SAVE_DATA_PATH/cINN_D_UNIT_hsi.txt"

# Please note that cINN_without_GAN and CycleGAN will be the values for 'inn' and 'unit', respectively.
echo "Train and evaluate Random Forest Classifier on HSI Data generated by cINN_without_GAN and CycleGAN"
cp -r "$cINN_WG_PATH_HSI" "$SAVE_DATA_PATH/results/inn/generated_spectra_data"
cp -r "$CYCLEGAN_PATH_HSI" "$SAVE_DATA_PATH/results/unit/generated_spectra_data"
python3 evaluation/si_classifier.py "--rf" "--target" "test" > "$SAVE_DATA_PATH/cINN_WG_CYCLEGAN_hsi.txt"

echo "Train and evaluate Random Forest Classifier on PAT Data generated by cINN_DY and UNIT_Y"
python3 evaluation/artery_vein_classifier.py "--target" "test" "--data_base_root" "$PAT_DATA_PATH" "--gan_cinn_root" "$cINN_DY_PATH/testing/training" "--unit_root" "$UNIT_Y_PATH/testing/training" > "$SAVE_DATA_PATH/cINN_DY_UNIT_Y.txt"
python3 visualization/plot_pai_spectra.py "--spectra" "--diff" "--target" "test" "--data_base_root" "$PAT_DATA_PATH" "--gan_cinn_root" "$cINN_DY_PATH/testing/training" "--unit_root" "$UNIT_Y_PATH/testing/training"
python3 evaluation/compute_pai_pca.py "--pca" "--target" "test" "--data_base_root" "$PAT_DATA_PATH" "--gan_cinn_root" "$cINN_DY_PATH/testing/training" "--unit_root" "$UNIT_Y_PATH/testing/training"

# The following lines plot the figures of the paper. Since we only showed cINN_DY and UNIT_Y in the paper, we don't include this for the other models.
echo "Train and evaluate Random Forest Classifier on HSI Data generated by cINN_DY and UNIT_Y"
cp -r "$cINN_DY_PATH_HSI" "$SAVE_DATA_PATH/results/inn/generated_spectra_data"
cp -r "$UNIT_Y_PATH_HSI" "$SAVE_DATA_PATH/results/unit/generated_spectra_data"
python3 evaluation/si_classifier.py "--rf" "--target" "test" > "$SAVE_DATA_PATH/cINN_DY_UNIT_Y_hsi.txt"

echo "Visualizing Results..."
python3 visualization/plot_semantic_spectra.py "--spectra" "--diff" "--pca"
python3 visualization/manuscript_plots.py